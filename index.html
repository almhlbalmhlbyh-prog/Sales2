<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ุชุชุจุน ุงููุจูุนุงุช ุงููุชูุฏู</title>
  <meta name="theme-color" content="#0ea5e9">
  <link rel="manifest" href="manifest.json">
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#0f172a; --muted:#6b7280; --accent:#0ea5e9; --danger:#ef4444; --border:#e5e7eb;
    }
    .dark:root, body.dark{ --bg:#0b1220; --card:#0f172a; --text:#e5e7eb; --muted:#a1a1aa; --accent:#38bdf8; --danger:#ef4444; --border:#1f2937; }
    *{box-sizing:border-box}
    body{font-family:system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;padding:20px;line-height:1.6}
    .container{background:var(--card);padding:20px;border-radius:16px;max-width:1100px;margin:auto;box-shadow:0 4px 24px rgba(2,8,23,.12);border:1px solid var(--border)}
    h1{font-size:28px;margin:0 0 6px}
    .sub{color:var(--muted);margin:0 0 14px}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input,select,button{padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text)}
    input::placeholder{color:var(--muted)}
    button{background:var(--accent);border-color:transparent;color:white;cursor:pointer}
    button.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    button.danger{background:#fee2e2;color:#991b1b;border-color:#fecaca}
    .grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px;margin:14px 0}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center}
    .card .k{font-size:22px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:12px;border:1px solid var(--border)}
    th,td{border-top:1px solid var(--border);padding:10px}
    th{background:rgba(2,8,23,.04);cursor:pointer}
    tfoot td{font-weight:bold;background:rgba(2,8,23,.04)}
    .actions{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
    .toolbar{margin:12px 0;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .section-title{margin-top:18px;margin-bottom:6px;font-weight:700}
    .muted{color:var(--muted);font-size:14px}
    .footer{margin-top:14px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;flex-wrap:wrap;gap:8px}
    canvas{width:100%;height:220px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
    .progress{height:10px;background:#e5e7eb;border-radius:999px;overflow:hidden}
    .progress > div{height:100%}
    @media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media print{
      #themeBtn,#installBtn,.toolbar,.actions,.no-print{display:none !important}
      body{padding:0;background:white} .container{box-shadow:none;border:none}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row" style="justify-content:space-between">
      <div>
        <h1>๐ ูุธุงู ุชุชุจุน ุงููุจูุนุงุช</h1>
        <p class="sub">ุณุฌูู ุงูุจูุนุ ุฑุงูุจ ุงูููุฎุตุงุช ูุงูุฅูุฑุงุฏุ ูุตุฏูุฑ ูุณุฎุฉ ุงุญุชูุงุทูุฉ.</p>
      </div>
      <div class="row">
        <button class="ghost" id="themeBtn">ุงููุถุน ุงููููู</button>
        <button class="ghost" id="installBtn" hidden>ุชุซุจูุช ูุชุทุจูู</button>
        <button class="ghost no-print" id="printBtn">ุทุจุงุนุฉ ุชูุฑูุฑ</button>
      </div>
    </div>

    <!-- ุฅุถุงูุฉ ุจูุน -->
    <div class="row">
      <input list="productsList" type="text" id="productName" placeholder="ุงุณู ุงูููุชุฌ">
      <datalist id="productsList"></datalist>
      <input type="number" id="salesInput" placeholder="ุนุฏุฏ ุงููุจูุนุงุช">
      <input type="number" id="priceInput" placeholder="ุณุนุฑ ุงููุญุฏุฉ (ุงุฎุชูุงุฑู) - OMR" step="0.001" min="0">
      <input type="date" id="dateInput">
      <button id="addBtn">ุฅุถุงูุฉ</button>
    </div>
    <div class="row muted">
      <label><input type="checkbox" id="mergeSameDay" checked> ุฏูุฌ ููุณ ุงูููุชุฌ ูู ููุณ ุงูููู ุชููุงุฆููุง</label>
      <button class="ghost" id="undoBtn">ุชุฑุงุฌุน (Undo)</button>
      <button class="ghost" id="clearFiltersBtn">ูุณุญ ุงูููุงุชุฑ</button>
    </div>

    <!-- ุฃูุฏุงู -->
    <div class="section-title">๐ฏ ุงูุฃูุฏุงู</div>
    <div class="row">
      <input type="number" id="targetDaily" placeholder="ูุฏู ูููู (ุนุฏุฏ)">
      <input type="number" id="targetMonthly" placeholder="ูุฏู ุดูุฑู (ุนุฏุฏ)">
      <button class="ghost" id="saveTargetsBtn">ุญูุธ ุงูุฃูุฏุงู</button>
    </div>
    <div class="grid">
      <div class="card"><div class="muted">ุฅุฌูุงูู ุงูููู</div><div class="k" id="sumToday">0</div><div class="progress"><div id="progDay" style="width:0%;background:#22c55e"></div></div></div>
      <div class="card"><div class="muted">ูุฐุง ุงูุฃุณุจูุน</div><div class="k" id="sumWeek">0</div></div>
      <div class="card"><div class="muted">ูุฐุง ุงูุดูุฑ</div><div class="k" id="sumMonth">0</div><div class="progress"><div id="progMonth" style="width:0%;background:#22c55e"></div></div></div>
      <div class="card"><div class="muted">ุงูุฅูุฑุงุฏ ุงููููู (OMR)</div><div class="k" id="revToday">0.000</div></div>
      <div class="card"><div class="muted">ุฃูุถู ุงูููุชุฌุงุช</div><div class="k" id="topProducts">-</div></div>
    </div>

    <!-- ููุงุชุฑ ูุจุญุซ ูุชุตุฏูุฑ -->
    <div class="toolbar">
      <select id="filterMode">
        <option value="all">ูู ุงูุณุฌูุงุช</option>
        <option value="today">ุงูููู</option>
        <option value="week">ูุฐุง ุงูุฃุณุจูุน</option>
        <option value="month">ูุฐุง ุงูุดูุฑ</option>
        <option value="range">ูุทุงู ุชุงุฑูุฎ</option>
      </select>
      <input type="date" id="fromDate" style="display:none">
      <input type="date" id="toDate" style="display:none">
      <input type="text" id="search" placeholder="ุจุญุซ ูู ุงูููุชุฌ...">
      <button class="ghost" id="exportCsv">ุชุตุฏูุฑ CSV (ุงููู)</button>
      <button class="ghost" id="exportCsvFiltered">ุชุตุฏูุฑ CSV (ุญุณุจ ุงูููุชุฑ)</button>
      <button class="ghost" id="backupBtn">ุชูุฒูู ูุณุฎุฉ ุงุญุชูุงุทูุฉ</button>
      <label class="ghost" style="padding:8px 12px;display:inline-block;cursor:pointer">
        ุงุณุชูุฑุงุฏ ูุณุฎุฉ
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <label class="ghost" style="padding:8px 12px;display:inline-block;cursor:pointer">
        ุงุณุชูุฑุงุฏ CSV
        <input id="importCsvInput" type="file" accept=".csv" style="display:none">
      </label>
    </div>

    <!-- ุฌุฏูู -->
    <table>
      <thead>
        <tr>
          <th data-sort="dateISO">ุงูุชุงุฑูุฎ</th>
          <th data-sort="product">ุงุณู ุงูููุชุฌ</th>
          <th data-sort="count">ุนุฏุฏ</th>
          <th data-sort="price">ุณุนุฑ/ูุญุฏุฉ</th>
          <th data-sort="revenue">ุงูุฅูุฑุงุฏ</th>
          <th>ุฅุฌุฑุงุก</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td colspan="2">ุงูุฅุฌูุงูู ุงูุธุงูุฑ</td>
          <td id="tfootCount">0</td>
          <td>-</td>
          <td id="tfootRevenue">0.000</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="toolbar">
      <select id="productSelect">
        <option value="">-- ุงุฎุชุฑ ุงูููุชุฌ ููุนุฑูุฉ ูุฌููุนู --</option>
      </select>
      <div class="muted" id="productTotalDisplay"></div>
      <button class="danger" id="deleteAllBtn">ุญุฐู ูู ุงูุณุฌูุงุช</button>
    </div>

    <div class="section-title">ุฑุณู ุจูุงูู (ุญุณุจ ุงูููุชุฑ)</div>
    <canvas id="chart" width="1100" height="240"></canvas>

    <div class="footer">
      <div>๐พ ุงูุจูุงูุงุช ูุญููุธุฉ ูุญูููุง (ุจุฏูู ุฅูุชุฑูุช). ููููู ุงููุณุฎ ุงูุงุญุชูุงุทู.</div>
      <div>๐ PIN ุงุฎุชูุงุฑู ููุญุฐู/ุงูุชุนุฏูู.</div>
    </div>

    <div class="toolbar">
      <input type="password" id="pinInput" placeholder="ุชุนููู/ุฅุฏุฎุงู PIN (ุงุฎุชูุงุฑู)">
      <button class="ghost" id="setPinBtn">ุญูุธ/ุชุบููุฑ PIN</button>
      <button class="ghost" id="clearPinBtn">ุฅุฒุงูุฉ PIN</button>
    </div>
  </div>

<script>
let sales = JSON.parse(localStorage.getItem('salesData')||'[]');
let settings = JSON.parse(localStorage.getItem('salesSettings')||'{}');
let sortState = { key:'dateISO', dir:'desc' };
let editId = null;
let undoStack = [];
const $ = sel=>document.querySelector(sel), $$ = sel=>document.querySelectorAll(sel);
function save(){ localStorage.setItem('salesData', JSON.stringify(sales)); }
function saveSettings(){ localStorage.setItem('salesSettings', JSON.stringify(settings)); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function inWeek(d){ const dt=new Date(d), now=new Date(); const sd=new Date(now); sd.setDate(now.getDate()-6); return dt<=now && dt>=sd; }
function inMonth(d){ const dt=new Date(d), now=new Date(); return dt.getUTCFullYear()==now.getUTCFullYear() && dt.getUTCMonth()==now.getUTCMonth(); }
function addUndo(){ undoStack.push(JSON.stringify(sales)); if(undoStack.length>20) undoStack.shift(); }

// ุชูููุฏ
if(!settings.theme) settings.theme='light';
document.body.classList.toggle('dark', settings.theme==='dark');
$('#dateInput').value = todayISO();
$('#mergeSameDay').checked = settings.mergeSameDay ?? true;
$('#targetDaily').value = settings.targetDaily || '';
$('#targetMonthly').value = settings.targetMonthly || '';

// ุฃุญุฏุงุซ ุนุงูุฉ
$('#themeBtn').onclick=()=>{ settings.theme = (settings.theme==='dark')?'light':'dark'; document.body.classList.toggle('dark', settings.theme==='dark'); saveSettings(); };
$('#printBtn').onclick=()=>window.print();
$('#addBtn').onclick=addSale;
$('#mergeSameDay').onchange=(e)=>{ settings.mergeSameDay = e.target.checked; saveSettings(); };
$('#filterMode').onchange=()=>{ const show=$('#filterMode').value==='range'; $('#fromDate').style.display=show?'block':'none'; $('#toDate').style.display=show?'block':'none'; render(); };
$('#fromDate').onchange=render; $('#toDate').onchange=render;
$('#search').oninput=render;
$('#exportCsv').onclick=()=>exportCSV(sales,'sales-all.csv');
$('#exportCsvFiltered').onclick=()=>exportCSV(filteredSales(),'sales-filtered.csv');
$('#backupBtn').onclick=downloadBackup;
$('#restoreInput').onchange=restoreBackup;
$('#importCsvInput').onchange=importCSV;
$('#deleteAllBtn').onclick=deleteAllConfirm;
$('#setPinBtn').onclick=()=>{ settings.pin=$('#pinInput').value||null; saveSettings(); alert(settings.pin?'ุชู ุญูุธ PIN':'ุชูุช ุฅุฒุงูุฉ PIN'); };
$('#clearPinBtn').onclick=()=>{ settings.pin=null; $('#pinInput').value=''; saveSettings(); alert('ุชูุช ุฅุฒุงูุฉ PIN'); };
$('#saveTargetsBtn').onclick=()=>{ settings.targetDaily=parseInt($('#targetDaily').value||0,10)||0; settings.targetMonthly=parseInt($('#targetMonthly').value||0,10)||0; saveSettings(); render(); };
$('#clearFiltersBtn').onclick=()=>{ $('#filterMode').value='all'; $('#fromDate').value=''; $('#toDate').value=''; $('#search').value=''; render(); };
$('#undoBtn').onclick=()=>{ if(!undoStack.length) return; sales = JSON.parse(undoStack.pop()); save(); render(); };
$$('th[data-sort]').forEach(th=> th.onclick=()=>sortBy(th.dataset.sort));

// PWA
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
let deferredPrompt; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; $('#installBtn').hidden=false; });
$('#installBtn').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBtn').hidden=true; } };

function checkPIN(){ if(!settings.pin) return true; const v=prompt('ุฃุฏุฎู PIN ูููุชุงุจุนุฉ'); if(v===null) return false; return v===settings.pin; }

function addSale(){
  const product=$('#productName').value.trim();
  const count=parseInt($('#salesInput').value,10);
  const price=parseFloat($('#priceInput').value);
  const dateISO=$('#dateInput').value || todayISO();
  if(!product) return alert('ุฃุฏุฎู ุงุณู ุงูููุชุฌ');
  if(!count || count<=0) return alert('ุฃุฏุฎู ุนุฏุฏ ุตุญูุญ');
  addUndo();
  const merge=$('#mergeSameDay').checked;
  if(merge){
    const found=sales.find(s=>s.product===product && s.dateISO===dateISO && (isNaN(price)?isNaN(s.price||NaN): (s.price||0)===price));
    if(found){ found.count += count; save(); render(); clearInputs(); return; }
  }
  sales.push({ id: Date.now(), product, count, price: isNaN(price)? null: Number(price), dateISO });
  save(); render(); clearInputs();
}
function clearInputs(){ $('#productName').value=''; $('#salesInput').value=''; $('#priceInput').value=''; $('#dateInput').value=todayISO(); }

function ensureMigrations(){
  let changed=false;
  sales.forEach(s=>{
    if(!s.id){ s.id=Date.now()+Math.floor(Math.random()*1e6); changed=true; }
    if(!s.dateISO && s.date){ const d=new Date(s.date); s.dateISO=isNaN(d)?todayISO(): d.toISOString().slice(0,10); changed=true; }
    if(s.price===undefined) s.price=null;
  });
  if(changed) save();
}

function sortBy(key){
  if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
  else { sortState.key=key; sortState.dir='asc'; }
  render();
}

function filteredSales(){
  const q=$('#search').value.trim().toLowerCase();
  const mode=$('#filterMode').value;
  const from=$('#fromDate').value; const to=$('#toDate').value;
  return sales.filter(s=>{
    if(q && !(s.product||'').toLowerCase().includes(q)) return false;
    if(mode==='today' && s.dateISO!==todayISO()) return false;
    if(mode==='week' && !inWeek(s.dateISO)) return false;
    if(mode==='month' && !inMonth(s.dateISO)) return false;
    if(mode==='range'){ if(from && s.dateISO<from) return false; if(to && s.dateISO>to) return false; }
    return true;
  }).sort((a,b)=>{
    const ka=a[sortState.key]; const kb=b[sortState.key];
    return (ka==kb?0:(ka>kb?1:-1)) * (sortState.dir==='asc'?1:-1);
  });
}

function sumToday(){ return sales.filter(s=>s.dateISO===todayISO()).reduce((t,s)=>t+s.count,0); }
function sumWeek(){ return sales.filter(s=>inWeek(s.dateISO)).reduce((t,s)=>t+s.count,0); }
function sumMonth(){ return sales.filter(s=>inMonth(s.dateISO)).reduce((t,s)=>t+s.count,0); }
function revenueToday(){ return sales.filter(s=>s.dateISO===todayISO()).reduce((t,s)=>t+(s.count*((s.price||0))),0); }
function top3(){ const map={}; sales.forEach(s=> map[s.product]=(map[s.product]||0)+s.count); return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k} (${v})`).join('ุ ') || '-'; }

function exportCSV(data, filename){
  const rows=[['date','product','count','price','revenue']].concat(
    data.map(s=>[s.dateISO, s.product, s.count, (s.price??''), (s.price? (s.count*s.price).toFixed(3): '')])
  );
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

function downloadBackup(){
  const data={ sales, settings };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`sales-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
}

function restoreBackup(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(Array.isArray(obj.sales)) sales=obj.sales; if(obj.settings) settings=obj.settings; save(); saveSettings(); render(); alert('ุชู ุงูุงุณุชูุฑุงุฏ'); } catch{ alert('ููู ุบูุฑ ุตุงูุญ'); } e.target.value=''; };
  reader.readAsText(file);
}

function importCSV(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const lines=reader.result.split(/\r?\n/).filter(Boolean);
    // ุชููุน ุฑุคูุณ: date,product,count,price (ุงุฎุชูุงุฑู),revenue (ุชูููู)
    const added=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(',').map(x=>x.replace(/^\"|\"$/g,'').replace(/\"\"/g,'"'));
      const dateISO=cols[0]||todayISO();
      const product=cols[1]||'';
      const count=parseInt(cols[2]||'0',10);
      const price=parseFloat(cols[3]||''); // ูุฏ ูููู ูุงุฑุบ
      if(!product || !count) continue;
      sales.push({ id: Date.now()+i, product, count, price: isNaN(price)? null: Number(price), dateISO });
      added.push(product);
    }
    save(); render(); alert(`ุชู ุงุณุชูุฑุงุฏ ${added.length} ุณุฌู`);
    e.target.value='';
  };
  reader.readAsText(file);
}

// ุชูุงุนู ุงูุฌุฏูู
function startEdit(id){ editId=id; render(); }
function cancelEdit(){ editId=null; render(); }
function saveRow(id){
  if(settings.pin && !checkPIN()) return alert('PIN ุบูุฑ ุตุญูุญ');
  const d=$('#e_date_'+id).value; const p=$('#e_prod_'+id).value.trim(); const c=parseInt($('#e_cnt_'+id).value,10); const pr=parseFloat($('#e_price_'+id).value);
  if(!p) return alert('ุงุณู ุงูููุชุฌ ูุทููุจ'); if(!c || c<=0) return alert('ุนุฏุฏ ุบูุฑ ุตุญูุญ');
  const row=sales.find(s=>s.id===id); if(!row) return;
  addUndo();
  row.dateISO = d || row.dateISO;
  row.product = p;
  row.count = c;
  row.price = isNaN(pr)? null: Number(pr);
  save(); editId=null; render();
}
function delRow(id){
  if(settings.pin && !checkPIN()) return alert('PIN ุบูุฑ ุตุญูุญ');
  if(!confirm('ุญุฐู ูุฐุง ุงูุณุฌูุ')) return;
  addUndo();
  sales = sales.filter(s=>s.id!==id); save(); render();
}

function updateProductSelect(){
  const names=Array.from(new Set(sales.map(s=>s.product||'ุบูุฑ ูุญุฏุฏ'))).sort();
  const sel=$('#productSelect'); sel.innerHTML='<option value="">-- ุงุฎุชุฑ ุงูููุชุฌ ููุนุฑูุฉ ูุฌููุนู --</option>';
  names.forEach(n=> sel.innerHTML += `<option value="${n}">${n}</option>`);
  // datalist ุงูุชุฑุงุญุงุช
  const dl=$('#productsList'); dl.innerHTML=''; names.forEach(n=> dl.innerHTML += `<option value="${n}">`);
}
$('#productSelect').onchange=()=>{
  const p=$('#productSelect').value; if(!p){ $('#productTotalDisplay').textContent=''; return; }
  const t=sales.filter(s=>s.product===p).reduce((sum,s)=>sum+s.count,0);
  $('#productTotalDisplay').textContent = `ุฅุฌูุงูู "${p}": ${t}`;
};

function drawChart(data){
  const cvs=$('#chart'), ctx=cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const map={}; data.forEach(s=> map[s.dateISO]=(map[s.dateISO]||0)+s.count);
  const entries=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  if(!entries.length){ ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted'); ctx.fillText('ูุง ุชูุฌุฏ ุจูุงูุงุช ูู ุงูููุชุฑ ุงูุญุงูู',20,30); return; }
  const labels=entries.map(e=>e[0]); const values=entries.map(e=>e[1]);
  const padL=40, padB=30; const W=cvs.width-padL-10; const H=cvs.height-10-padB;
  const maxV=Math.max(...values);
  ctx.strokeStyle='#94a3b8'; ctx.beginPath(); ctx.moveTo(padL,10); ctx.lineTo(padL,10+H); ctx.lineTo(padL+W,10+H); ctx.stroke();
  const barW=Math.max(10, Math.min(60, W/values.length - 8));
  values.forEach((v,i)=>{
    const x=padL + i*(barW+8) + 8;
    const h=Math.round((v/maxV)*(H-10));
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#0ea5e9';
    ctx.fillRect(x, 10+H-h, barW, h);
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text'); ctx.font='12px sans-serif';
    ctx.fillText(String(v), x, 10+H-h-4);
    ctx.save(); ctx.translate(x+barW/2, 10+H+12); ctx.rotate(-Math.PI/6); ctx.textAlign='right'; ctx.fillText(labels[i].slice(5), 0, 0); ctx.restore();
  });
}

function renderTable(data){
  const tb=$('#rows'); tb.innerHTML='';
  let totalCount=0,totalRevenue=0;
  data.forEach(row=>{
    const rev = (row.price? (row.price*row.count): 0);
    totalCount += row.count||0;
    totalRevenue += rev;
    const tr=document.createElement('tr');
    if(editId===row.id){
      tr.innerHTML = `
        <td><input type="date" id="e_date_${row.id}" value="${row.dateISO||''}"></td>
        <td><input type="text" id="e_prod_${row.id}" value="${row.product||''}"></td>
        <td><input type="number" min="1" id="e_cnt_${row.id}" value="${row.count||1}"></td>
        <td><input type="number" step="0.001" min="0" id="e_price_${row.id}" value="${row.price??''}"></td>
        <td>${rev.toFixed(3)}</td>
        <td class="actions">
          <button class="ghost" onclick="saveRow(${row.id})">ุญูุธ</button>
          <button class="ghost" onclick="cancelEdit()">ุฅูุบุงุก</button>
          <button class="danger" onclick="delRow(${row.id})">ุญุฐู</button>
        </td>`;
    } else {
      tr.innerHTML = `
        <td>${row.dateISO||''}</td>
        <td>${row.product||'ุบูุฑ ูุญุฏุฏ'}</td>
        <td>${row.count||0}</td>
        <td>${row.price!=null? Number(row.price).toFixed(3): '-'}</td>
        <td>${rev.toFixed(3)}</td>
        <td class="actions">
          <button class="ghost" onclick="startEdit(${row.id})">ุชุนุฏูู</button>
          <button class="danger" onclick="delRow(${row.id})">ุญุฐู</button>
        </td>`;
    }
    tb.appendChild(tr);
  });
  $('#tfootCount').textContent = totalCount;
  $('#tfootRevenue').textContent = totalRevenue.toFixed(3);
}

function render(){
  ensureMigrations();
  // ููุฎุตุงุช
  const tDay=sumToday(), tWeek=sumWeek(), tMonth=sumMonth(), rDay=revenueToday();
  $('#sumToday').textContent=tDay; $('#sumWeek').textContent=tWeek; $('#sumMonth').textContent=tMonth; $('#revToday').textContent=rDay.toFixed(3);
  $('#topProducts').textContent=top3();

  // ุชูุฏู ุงูุฃูุฏุงู
  const td = settings.targetDaily||0, tm = settings.targetMonthly||0;
  $('#progDay').style.width = td? Math.min(100, Math.round((tDay/td)*100))+'%':'0%';
  $('#progMonth').style.width = tm? Math.min(100, Math.round((tMonth/tm)*100))+'%':'0%';

  // ุฌุฏูู ููุฑุดูุญ ูููุฑุชูุจ
  const data=filteredSales();
  renderTable(data);
  updateProductSelect();
  drawChart(data);
  // ุงูุชุฑุงุญุงุช ุงูููุชุฌุงุช
  updateProductSelect();
}

render();
</script>
</body>
</html>
