<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</title>
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; background: #f5f5f5; text-align: center; }
    .container { background: white; padding: 20px; margin: 20px auto; border-radius: 10px; max-width: 500px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    input, select, button { padding: 8px; margin: 5px; border-radius: 5px; border: 1px solid #ccc; width: 90%; }
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    .edit-btn { background: orange; color: white; padding: 5px; border: none; border-radius: 5px; cursor: pointer; }
    .delete-btn { background: red; color: white; padding: 5px; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>

<div class="container">
  <h2>ğŸ“Š Ù†Ø¸Ø§Ù… ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h2>
  <input type="text" id="productName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
  <input type="number" id="productQty" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª">
  <button onclick="addSale()">Ø¥Ø¶Ø§ÙØ©</button>

  <h3 id="totalSales">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: 0</h3>
  <table id="salesTable">
    <tr>
      <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
      <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
      <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  </table>

  <h4>Ø§Ø®ØªØ± Ù…Ù†ØªØ¬ Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨ÙŠØ¹Ø§ØªÙ‡:</h4>
  <input type="text" id="filterProduct" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬">
  <button onclick="filterSales()">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</button>
  <p id="productTotal"></p>
</div>

<script>
  let sales = JSON.parse(localStorage.getItem("sales")) || [];

  function saveData() {
    localStorage.setItem("sales", JSON.stringify(sales));
  }

  function renderTable() {
    let table = document.getElementById("salesTable");
    table.innerHTML = `
      <tr>
        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
      </tr>
    `;
    let total = 0;
    sales.forEach((sale, index) => {
      total += sale.qty;
      table.innerHTML += `
        <tr>
          <td>${sale.date}</td>
          <td>${sale.name}</td>
          <td>${sale.qty}</td>
          <td>
            <button class="edit-btn" onclick="editSale(${index})">ØªØ¹Ø¯ÙŠÙ„</button>
            <button class="delete-btn" onclick="deleteSale(${index})">Ø­Ø°Ù</button>
          </td>
        </tr>
      `;
    });
    document.getElementById("totalSales").innerText = "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: " + total;
  }

  function addSale() {
    let name = document.getElementById("productName").value;
    let qty = parseInt(document.getElementById("productQty").value);
    if (!name || isNaN(qty) || qty <= 0) return alert("Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ­ÙŠØ­Ø©");
    let today = new Date().toLocaleDateString("ar-EG");
    sales.push({ date: today, name: name, qty: qty });
    saveData();
    renderTable();
    document.getElementById("productName").value = "";
    document.getElementById("productQty").value = "";
  }

  function deleteSale(index) {
    if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ")) {
      sales.splice(index, 1);
      saveData();
      renderTable();
    }
  }

  function editSale(index) {
    let newName = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ø¬Ø¯ÙŠØ¯", sales[index].name);
    let newQty = parseInt(prompt("Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯", sales[index].qty));
    if (!newName || isNaN(newQty) || newQty <= 0) return alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    sales[index].name = newName;
    sales[index].qty = newQty;
    saveData();
    renderTable();
  }

  function filterSales() {
    let filterName = document.getElementById("filterProduct").value;
    if (!filterName) return alert("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬");
    let sum = sales.filter(s => s.name === filterName).reduce((acc, s) => acc + s.qty, 0);
    document.getElementById("productTotal").innerText = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø¨ÙŠØ¹Ø§Øª "${filterName}": ${sum}`;
  }

  renderTable();
</script>

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.error("SW registration failed:", err));
  }
</script>

</body>
</html>      <label class="ghost" style="padding:8px 12px;display:inline-block;cursor:pointer">
        Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù†Ø³Ø®Ø©
        <input id="restoreInput" type="file" accept=".json" style="display:none">
      </label>
      <label class="ghost" style="padding:8px 12px;display:inline-block;cursor:pointer">
        Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
        <input id="importCsvInput" type="file" accept=".csv" style="display:none">
      </label>
    </div>

    <!-- Ø¬Ø¯ÙˆÙ„ -->
    <table>
      <thead>
        <tr>
          <th data-sort="dateISO">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
          <th data-sort="product">Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬</th>
          <th data-sort="count">Ø¹Ø¯Ø¯</th>
          <th data-sort="price">Ø³Ø¹Ø±/ÙˆØ­Ø¯Ø©</th>
          <th data-sort="revenue">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td colspan="2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¸Ø§Ù‡Ø±</td>
          <td id="tfootCount">0</td>
          <td>-</td>
          <td id="tfootRevenue">0.000</td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <div class="toolbar">
      <select id="productSelect">
        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ù‡ --</option>
      </select>
      <div class="muted" id="productTotalDisplay"></div>
      <button class="danger" id="deleteAllBtn">Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
    </div>

    <div class="section-title">Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ (Ø­Ø³Ø¨ Ø§Ù„ÙÙ„ØªØ±)</div>
    <canvas id="chart" width="1100" height="240"></canvas>

    <div class="footer">
      <div>ğŸ’¾ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª). ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ.</div>
      <div>ğŸ” PIN Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„Ø­Ø°Ù/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„.</div>
    </div>

    <div class="toolbar">
      <input type="password" id="pinInput" placeholder="ØªØ¹ÙŠÙŠÙ†/Ø¥Ø¯Ø®Ø§Ù„ PIN (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
      <button class="ghost" id="setPinBtn">Ø­ÙØ¸/ØªØºÙŠÙŠØ± PIN</button>
      <button class="ghost" id="clearPinBtn">Ø¥Ø²Ø§Ù„Ø© PIN</button>
    </div>
  </div>

<script>
let sales = JSON.parse(localStorage.getItem('salesData')||'[]');
let settings = JSON.parse(localStorage.getItem('salesSettings')||'{}');
let sortState = { key:'dateISO', dir:'desc' };
let editId = null;
let undoStack = [];
const $ = sel=>document.querySelector(sel), $$ = sel=>document.querySelectorAll(sel);
function save(){ localStorage.setItem('salesData', JSON.stringify(sales)); }
function saveSettings(){ localStorage.setItem('salesSettings', JSON.stringify(settings)); }
function todayISO(){ return new Date().toISOString().slice(0,10); }
function inWeek(d){ const dt=new Date(d), now=new Date(); const sd=new Date(now); sd.setDate(now.getDate()-6); return dt<=now && dt>=sd; }
function inMonth(d){ const dt=new Date(d), now=new Date(); return dt.getUTCFullYear()==now.getUTCFullYear() && dt.getUTCMonth()==now.getUTCMonth(); }
function addUndo(){ undoStack.push(JSON.stringify(sales)); if(undoStack.length>20) undoStack.shift(); }

// ØªÙ…Ù‡ÙŠØ¯
if(!settings.theme) settings.theme='light';
document.body.classList.toggle('dark', settings.theme==='dark');
$('#dateInput').value = todayISO();
$('#mergeSameDay').checked = settings.mergeSameDay ?? true;
$('#targetDaily').value = settings.targetDaily || '';
$('#targetMonthly').value = settings.targetMonthly || '';

// Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø©
$('#themeBtn').onclick=()=>{ settings.theme = (settings.theme==='dark')?'light':'dark'; document.body.classList.toggle('dark', settings.theme==='dark'); saveSettings(); };
$('#printBtn').onclick=()=>window.print();
$('#addBtn').onclick=addSale;
$('#mergeSameDay').onchange=(e)=>{ settings.mergeSameDay = e.target.checked; saveSettings(); };
$('#filterMode').onchange=()=>{ const show=$('#filterMode').value==='range'; $('#fromDate').style.display=show?'block':'none'; $('#toDate').style.display=show?'block':'none'; render(); };
$('#fromDate').onchange=render; $('#toDate').onchange=render;
$('#search').oninput=render;
$('#exportCsv').onclick=()=>exportCSV(sales,'sales-all.csv');
$('#exportCsvFiltered').onclick=()=>exportCSV(filteredSales(),'sales-filtered.csv');
$('#backupBtn').onclick=downloadBackup;
$('#restoreInput').onchange=restoreBackup;
$('#importCsvInput').onchange=importCSV;
$('#deleteAllBtn').onclick=deleteAllConfirm;
$('#setPinBtn').onclick=()=>{ settings.pin=$('#pinInput').value||null; saveSettings(); alert(settings.pin?'ØªÙ… Ø­ÙØ¸ PIN':'ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© PIN'); };
$('#clearPinBtn').onclick=()=>{ settings.pin=null; $('#pinInput').value=''; saveSettings(); alert('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© PIN'); };
$('#saveTargetsBtn').onclick=()=>{ settings.targetDaily=parseInt($('#targetDaily').value||0,10)||0; settings.targetMonthly=parseInt($('#targetMonthly').value||0,10)||0; saveSettings(); render(); };
$('#clearFiltersBtn').onclick=()=>{ $('#filterMode').value='all'; $('#fromDate').value=''; $('#toDate').value=''; $('#search').value=''; render(); };
$('#undoBtn').onclick=()=>{ if(!undoStack.length) return; sales = JSON.parse(undoStack.pop()); save(); render(); };
$$('th[data-sort]').forEach(th=> th.onclick=()=>sortBy(th.dataset.sort));

// PWA
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }
let deferredPrompt; window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt=e; $('#installBtn').hidden=false; });
$('#installBtn').onclick=async()=>{ if(deferredPrompt){ deferredPrompt.prompt(); deferredPrompt=null; $('#installBtn').hidden=true; } };

function checkPIN(){ if(!settings.pin) return true; const v=prompt('Ø£Ø¯Ø®Ù„ PIN Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©'); if(v===null) return false; return v===settings.pin; }

function addSale(){
  const product=$('#productName').value.trim();
  const count=parseInt($('#salesInput').value,10);
  const price=parseFloat($('#priceInput').value);
  const dateISO=$('#dateInput').value || todayISO();
  if(!product) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬');
  if(!count || count<=0) return alert('Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­');
  addUndo();
  const merge=$('#mergeSameDay').checked;
  if(merge){
    const found=sales.find(s=>s.product===product && s.dateISO===dateISO && (isNaN(price)?isNaN(s.price||NaN): (s.price||0)===price));
    if(found){ found.count += count; save(); render(); clearInputs(); return; }
  }
  sales.push({ id: Date.now(), product, count, price: isNaN(price)? null: Number(price), dateISO });
  save(); render(); clearInputs();
}
function clearInputs(){ $('#productName').value=''; $('#salesInput').value=''; $('#priceInput').value=''; $('#dateInput').value=todayISO(); }

function ensureMigrations(){
  let changed=false;
  sales.forEach(s=>{
    if(!s.id){ s.id=Date.now()+Math.floor(Math.random()*1e6); changed=true; }
    if(!s.dateISO && s.date){ const d=new Date(s.date); s.dateISO=isNaN(d)?todayISO(): d.toISOString().slice(0,10); changed=true; }
    if(s.price===undefined) s.price=null;
  });
  if(changed) save();
}

function sortBy(key){
  if(sortState.key===key){ sortState.dir = (sortState.dir==='asc'?'desc':'asc'); }
  else { sortState.key=key; sortState.dir='asc'; }
  render();
}

function filteredSales(){
  const q=$('#search').value.trim().toLowerCase();
  const mode=$('#filterMode').value;
  const from=$('#fromDate').value; const to=$('#toDate').value;
  return sales.filter(s=>{
    if(q && !(s.product||'').toLowerCase().includes(q)) return false;
    if(mode==='today' && s.dateISO!==todayISO()) return false;
    if(mode==='week' && !inWeek(s.dateISO)) return false;
    if(mode==='month' && !inMonth(s.dateISO)) return false;
    if(mode==='range'){ if(from && s.dateISO<from) return false; if(to && s.dateISO>to) return false; }
    return true;
  }).sort((a,b)=>{
    const ka=a[sortState.key]; const kb=b[sortState.key];
    return (ka==kb?0:(ka>kb?1:-1)) * (sortState.dir==='asc'?1:-1);
  });
}

function sumToday(){ return sales.filter(s=>s.dateISO===todayISO()).reduce((t,s)=>t+s.count,0); }
function sumWeek(){ return sales.filter(s=>inWeek(s.dateISO)).reduce((t,s)=>t+s.count,0); }
function sumMonth(){ return sales.filter(s=>inMonth(s.dateISO)).reduce((t,s)=>t+s.count,0); }
function revenueToday(){ return sales.filter(s=>s.dateISO===todayISO()).reduce((t,s)=>t+(s.count*((s.price||0))),0); }
function top3(){ const map={}; sales.forEach(s=> map[s.product]=(map[s.product]||0)+s.count); return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([k,v])=>`${k} (${v})`).join('ØŒ ') || '-'; }

function exportCSV(data, filename){
  const rows=[['date','product','count','price','revenue']].concat(
    data.map(s=>[s.dateISO, s.product, s.count, (s.price??''), (s.price? (s.count*s.price).toFixed(3): '')])
  );
  const csv=rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
}

function downloadBackup(){
  const data={ sales, settings };
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`sales-backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
}

function restoreBackup(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{ try{ const obj=JSON.parse(reader.result); if(Array.isArray(obj.sales)) sales=obj.sales; if(obj.settings) settings=obj.settings; save(); saveSettings(); render(); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯'); } catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } e.target.value=''; };
  reader.readAsText(file);
}

function importCSV(e){
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    const lines=reader.result.split(/\r?\n/).filter(Boolean);
    // ØªÙˆÙ‚Ø¹ Ø±Ø¤ÙˆØ³: date,product,count,price (Ø§Ø®ØªÙŠØ§Ø±ÙŠ),revenue (ØªÙÙ‡Ù…Ù„)
    const added=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(',').map(x=>x.replace(/^\"|\"$/g,'').replace(/\"\"/g,'"'));
      const dateISO=cols[0]||todayISO();
      const product=cols[1]||'';
      const count=parseInt(cols[2]||'0',10);
      const price=parseFloat(cols[3]||''); // Ù‚Ø¯ ÙŠÙƒÙˆÙ† ÙØ§Ø±Øº
      if(!product || !count) continue;
      sales.push({ id: Date.now()+i, product, count, price: isNaN(price)? null: Number(price), dateISO });
      added.push(product);
    }
    save(); render(); alert(`ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ ${added.length} Ø³Ø¬Ù„`);
    e.target.value='';
  };
  reader.readAsText(file);
}

// ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function startEdit(id){ editId=id; render(); }
function cancelEdit(){ editId=null; render(); }
function saveRow(id){
  if(settings.pin && !checkPIN()) return alert('PIN ØºÙŠØ± ØµØ­ÙŠØ­');
  const d=$('#e_date_'+id).value; const p=$('#e_prod_'+id).value.trim(); const c=parseInt($('#e_cnt_'+id).value,10); const pr=parseFloat($('#e_price_'+id).value);
  if(!p) return alert('Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨'); if(!c || c<=0) return alert('Ø¹Ø¯Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­');
  const row=sales.find(s=>s.id===id); if(!row) return;
  addUndo();
  row.dateISO = d || row.dateISO;
  row.product = p;
  row.count = c;
  row.price = isNaN(pr)? null: Number(pr);
  save(); editId=null; render();
}
function delRow(id){
  if(settings.pin && !checkPIN()) return alert('PIN ØºÙŠØ± ØµØ­ÙŠØ­');
  if(!confirm('Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ØŸ')) return;
  addUndo();
  sales = sales.filter(s=>s.id!==id); save(); render();
}

function updateProductSelect(){
  const names=Array.from(new Set(sales.map(s=>s.product||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'))).sort();
  const sel=$('#productSelect'); sel.innerHTML='<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø¬Ù…ÙˆØ¹Ù‡ --</option>';
  names.forEach(n=> sel.innerHTML += `<option value="${n}">${n}</option>`);
  // datalist Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª
  const dl=$('#productsList'); dl.innerHTML=''; names.forEach(n=> dl.innerHTML += `<option value="${n}">`);
}
$('#productSelect').onchange=()=>{
  const p=$('#productSelect').value; if(!p){ $('#productTotalDisplay').textContent=''; return; }
  const t=sales.filter(s=>s.product===p).reduce((sum,s)=>sum+s.count,0);
  $('#productTotalDisplay').textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ "${p}": ${t}`;
};

function drawChart(data){
  const cvs=$('#chart'), ctx=cvs.getContext('2d');
  ctx.clearRect(0,0,cvs.width,cvs.height);
  const map={}; data.forEach(s=> map[s.dateISO]=(map[s.dateISO]||0)+s.count);
  const entries=Object.entries(map).sort((a,b)=>a[0].localeCompare(b[0]));
  if(!entries.length){ ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--muted'); ctx.fillText('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ',20,30); return; }
  const labels=entries.map(e=>e[0]); const values=entries.map(e=>e[1]);
  const padL=40, padB=30; const W=cvs.width-padL-10; const H=cvs.height-10-padB;
  const maxV=Math.max(...values);
  ctx.strokeStyle='#94a3b8'; ctx.beginPath(); ctx.moveTo(padL,10); ctx.lineTo(padL,10+H); ctx.lineTo(padL+W,10+H); ctx.stroke();
  const barW=Math.max(10, Math.min(60, W/values.length - 8));
  values.forEach((v,i)=>{
    const x=padL + i*(barW+8) + 8;
    const h=Math.round((v/maxV)*(H-10));
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#0ea5e9';
    ctx.fillRect(x, 10+H-h, barW, h);
    ctx.fillStyle=getComputedStyle(document.body).getPropertyValue('--text'); ctx.font='12px sans-serif';
    ctx.fillText(String(v), x, 10+H-h-4);
    ctx.save(); ctx.translate(x+barW/2, 10+H+12); ctx.rotate(-Math.PI/6); ctx.textAlign='right'; ctx.fillText(labels[i].slice(5), 0, 0); ctx.restore();
  });
}

function renderTable(data){
  const tb=$('#rows'); tb.innerHTML='';
  let totalCount=0,totalRevenue=0;
  data.forEach(row=>{
    const rev = (row.price? (row.price*row.count): 0);
    totalCount += row.count||0;
    totalRevenue += rev;
    const tr=document.createElement('tr');
    if(editId===row.id){
      tr.innerHTML = `
        <td><input type="date" id="e_date_${row.id}" value="${row.dateISO||''}"></td>
        <td><input type="text" id="e_prod_${row.id}" value="${row.product||''}"></td>
        <td><input type="number" min="1" id="e_cnt_${row.id}" value="${row.count||1}"></td>
        <td><input type="number" step="0.001" min="0" id="e_price_${row.id}" value="${row.price??''}"></td>
        <td>${rev.toFixed(3)}</td>
        <td class="actions">
          <button class="ghost" onclick="saveRow(${row.id})">Ø­ÙØ¸</button>
          <button class="ghost" onclick="cancelEdit()">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="danger" onclick="delRow(${row.id})">Ø­Ø°Ù</button>
        </td>`;
    } else {
      tr.innerHTML = `
        <td>${row.dateISO||''}</td>
        <td>${row.product||'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</td>
        <td>${row.count||0}</td>
        <td>${row.price!=null? Number(row.price).toFixed(3): '-'}</td>
        <td>${rev.toFixed(3)}</td>
        <td class="actions">
          <button class="ghost" onclick="startEdit(${row.id})">ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="danger" onclick="delRow(${row.id})">Ø­Ø°Ù</button>
        </td>`;
    }
    tb.appendChild(tr);
  });
  $('#tfootCount').textContent = totalCount;
  $('#tfootRevenue').textContent = totalRevenue.toFixed(3);
}

function render(){
  ensureMigrations();
  // Ù…Ù„Ø®ØµØ§Øª
  const tDay=sumToday(), tWeek=sumWeek(), tMonth=sumMonth(), rDay=revenueToday();
  $('#sumToday').textContent=tDay; $('#sumWeek').textContent=tWeek; $('#sumMonth').textContent=tMonth; $('#revToday').textContent=rDay.toFixed(3);
  $('#topProducts').textContent=top3();

  // ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
  const td = settings.targetDaily||0, tm = settings.targetMonthly||0;
  $('#progDay').style.width = td? Math.min(100, Math.round((tDay/td)*100))+'%':'0%';
  $('#progMonth').style.width = tm? Math.min(100, Math.round((tMonth/tm)*100))+'%':'0%';

  // Ø¬Ø¯ÙˆÙ„ Ù…ÙØ±Ø´Ù‘Ø­ ÙˆÙ…ÙØ±ØªÙ‘Ø¨
  const data=filteredSales();
  renderTable(data);
  updateProductSelect();
  drawChart(data);
  // Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
  updateProductSelect();
}

render();
</script>
</body>
</html>
